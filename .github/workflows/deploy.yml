name: Deploy to AWS

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

permissions:
  id-token: write   # required for OIDC with AWS
  contents: read

jobs:
  build-push:
    name: Build and push to ECR
    runs-on: ubuntu-latest
    outputs:
      ecr_image: ${{ steps.build-push.outputs.ecr_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/vintage-story-server:$IMAGE_TAG .
          docker push $ECR_REGISTRY/vintage-story-server:$IMAGE_TAG
          docker tag $ECR_REGISTRY/vintage-story-server:$IMAGE_TAG $ECR_REGISTRY/vintage-story-server:latest
          docker push $ECR_REGISTRY/vintage-story-server:latest
          echo "ecr_image=$ECR_REGISTRY/vintage-story-server:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-push
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy via SSM (pull and restart container)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
        run: |
          IMAGE="$ECR_REGISTRY/vintage-story-server:latest"
          PARAMS=$(jq -cn \
            --arg img "$IMAGE" \
            --arg reg "$ECR_REGISTRY" \
            '{commands: [
              "REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)",
              "aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin " + $reg,
              "docker pull " + $img,
              "docker stop vintagestory_server 2>/dev/null || true",
              "docker rm vintagestory_server 2>/dev/null || true",
              "docker run -d --name vintagestory_server --restart unless-stopped -p 42420:42420 -p 42420:42420/udp -v /var/vintagestory/data:/var/vintagestory/data -e VS_VERSION=1.21.6 " + $img
            ]}')
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMS" \
            --output text \
            --query 'Command.CommandId')

          echo "Waiting for command $COMMAND_ID to complete..."
          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$EC2_INSTANCE_ID"

          STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$EC2_INSTANCE_ID" --query 'Status' --output text)
          if [ "$STATUS" != "Success" ]; then
            echo "Deploy failed. Output:"
            aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$EC2_INSTANCE_ID"
            exit 1
          fi
          echo "Deploy complete."
